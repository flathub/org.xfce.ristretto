app-id: org.xfce.ristretto
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: ristretto
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
finish-args:
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # the open dialog is native, but we still need this to open files via the command line
  # and drag and drop, and to delete files
  - --filesystem=host
  # FIXME: necessary for Tumbler to emit signals, see
  # https://github.com/flathub/flathub/issues/2770
  # https://github.com/flathub/org.xfce.ristretto/pull/7
  - --socket=session-bus
  - --talk-name=org.freedesktop.FileManager1
  # access remote locations with GVfs
  - --filesystem=xdg-run/gvfs
  # see below, at the end of the pixbuf loader list
  - --env=GDK_PIXBUF_MODULE_FILE=/app/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache

cleanup:
  - '*.a'
  - '*.la'
  - /lib/cmake
  - /lib/girepository-1.0
  - /lib/pkgconfig
  - /include
  - /share/gir-1.0
  - /share/gtk-doc

modules:
  # mandatory dependencies
  - name: libxfce4util
    cleanup:
      - /sbin
    buildsystem: meson
    config-opts:
      - --buildtype=minsize
      - --auto-features=enabled
      - -Dvala=disabled
    sources:
      - type: archive
        url: https://archive.xfce.org/src/xfce/libxfce4util/4.20/libxfce4util-4.20.1.tar.bz2
        sha256: 84bfc4daab9e466193540c3665eee42b2cf4d24e3f38fc3e8d1e0a2bebe3b8f1
        x-checker-data:
          type: anitya
          project-id: 232001
          url-template: https://archive.xfce.org/src/xfce/libxfce4util/$major.$minor/libxfce4util-$version.tar.bz2

  - name: xfconf
    cleanup:
      - /bin
      - /share/bash-completion
    buildsystem: meson
    config-opts:
      - --auto-features=enabled
      - --buildtype=minsize
      - -Dvala=disabled
      - -Dservice-name-prefix=org.xfce.ristretto
    sources:
      - type: archive
        url: https://archive.xfce.org/src/xfce/xfconf/4.21/xfconf-4.21.0.tar.xz
        sha256: 0c2d749cc9109e5c5f2b92687faa20b7136c38ff5873e3b5d3ee53fe4e7cf1d4
        x-checker-data:
          type: anitya
          project-id: 14854
          stable-only: false
          url-template: https://archive.xfce.org/src/xfce/xfconf/$major.$minor/xfconf-$version.tar.xz

  - name: libxfce4ui
    cleanup:
      - /bin
      - /etc
      - /share/icons
      - /share/applications
    buildsystem: meson
    config-opts:
      - --auto-features=enabled
      - --buildtype=minsize
      - -Dvala=disabled
      - -Dstartup-notification=disabled
      - -Dlibgtop=disabled
      - -Dglade=disabled
    sources:
      - type: archive
        url: https://archive.xfce.org/src/xfce/libxfce4ui/4.21/libxfce4ui-4.21.0.tar.xz
        sha256: dd75ff86b6ac814cf71c66004494394eeab962f5360e8e88fa724fa972b9da7b
      - type: patch
        path: patches/0001-meson-build-Define-missing-dependencies-when-libgtop.patch
      - type: patch
        path: patches/0001-build-Replace-xdt-csource-with-glib-compile-resource.patch
      - type: patch
        path: patches/0002-build-Add-xdt-gen-visibility-to-get-rid-of-autotools.patch
        x-checker-data:
          type: anitya
          project-id: 232000
          stable-only: false
          url-template: https://archive.xfce.org/src/xfce/libxfce4ui/$major.$minor/libxfce4ui-$version.tar.xz

  # Tumbler as a private service, just as Xfconf above: stricly speaking it is not a
  # mandatory dependency, but in the Flatpak context it almost becomes one, and it
  # allows the application to be more self-contained
  - name: tumbler
    cleanup:
      - /lib/systemd
      - /share/icons
    post-install:
      - sed -i '/^SystemdService=/d' /app/share/dbus-1/services/org.xfce.ristretto.*.service
    buildsystem: meson
    config-opts:
      - --buildtype=minsize
      - --auto-features=enabled
      - -Dcover-thumbnailer=disabled
      - -Dfont-thumbnailer=disabled
      - -Dffmpeg-thumbnailer=disabled
      - -Dgst-thumbnailer=disabled
      - -Dodf-thumbnailer=disabled
      - -Dpoppler-thumbnailer=disabled
      - -Dgepub-thumbnailer=disabled
      - -Dservice-name-prefix=org.xfce.ristretto
      - -Draw-thumbnailer=disabled
    sources:
      - type: archive
        url: https://archive.xfce.org/src/xfce/tumbler/4.21/tumbler-4.21.1.tar.xz
        sha256: 0f499f79a2a7ee49726a433584dd8a680d514101b72bd1b003360611ce1dc244
        x-checker-data:
          type: anitya
          project-id: 5014
          stable-only: false
          url-template: https://archive.xfce.org/src/xfce/tumbler/$major.$minor/tumbler-$version.tar.xz

  - name: ristretto
    buildsystem: meson
    config-opts:
      - --buildtype=minsize
      - --auto-features=enabled
      - -Dservice-name-prefix=org.xfce.ristretto
    sources:
      - type: archive
        url: https://archive.xfce.org/src/apps/ristretto/0.13/ristretto-0.13.4.tar.xz
        sha256: a84ef8cb80638681d9b9ef09cddff86a5d7a0e028603b4a601cf0ff6c2869ce8
        x-checker-data:
          type: anitya
          project-id: 8365
          url-template: https://archive.xfce.org/src/apps/ristretto/$major.$minor/ristretto-$version.tar.xz
